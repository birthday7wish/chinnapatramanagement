<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Chinnapatra Post Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        crossorigin="anonymous" />
  <!-- Bootstrap Icons -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

  <style>
    :root {
      --cp-bg: #f2edff;
      --cp-bg-alt: #ffffff;
      --cp-primary: #7a3cff;
      --cp-primary-soft: #e3d7ff;
      --cp-accent: #ffca3a;
      --cp-danger: #ff595e;
      --cp-success: #8ac926;
      --cp-text-main: #1f1633;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--cp-text-main);
      background:
        radial-gradient(circle at top left, #fefbff 0, #f2edff 35%, #fff 100%);
      overflow-x: hidden;
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes softPulse {
      0% { box-shadow: 0 0 0 0 rgba(122, 60, 255, 0.2); }
      70% { box-shadow: 0 0 0 12px rgba(122, 60, 255, 0); }
      100% { box-shadow: 0 0 0 0 rgba(122, 60, 255, 0); }
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.86);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 22px;
      border: 1px solid rgba(122, 60, 255, 0.14);
      box-shadow:
        0 24px 60px rgba(31, 24, 76, 0.15),
        0 0 0 1px rgba(255, 255, 255, 0.9);
      animation: fadeUp .45s ease-out;
    }

    .cp-auth-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 12px;
    }

    .cp-auth-card {
      max-width: 440px;
      width: 100%;
      padding: 26px 26px 20px;
      position: relative;
      overflow: hidden;
    }

    .cp-auth-card::before {
      content: "";
      position: absolute;
      width: 190px;
      height: 190px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(122,60,255,0.16), transparent 60%);
      top: -70px;
      right: -60px;
      pointer-events: none;
    }

    .cp-logo-badge {
      width: 60px;
      height: 60px;
      border-radius: 20px;
      background: radial-gradient(circle at 10% 0, #ffe29f 0, #ffa99f 40%, #7a3cff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 700;
      font-size: 22px;
      box-shadow: 0 14px 36px rgba(122, 60, 255, 0.6);
      animation: softPulse 2.1s infinite;
    }

    .cp-auth-title {
      font-weight: 700;
      font-size: 1.26rem;
      margin-top: 10px;
    }

    .cp-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(122, 60, 255, 0.08);
      color: var(--cp-primary);
    }

    .cp-form-control {
      border-radius: 999px;
      border: 1px solid #e0d4ff;
      padding-inline: 14px;
      padding-block: 8px;
      font-size: 14px;
      background-color: rgba(255,255,255,0.9);
    }

    .cp-form-control:focus {
      outline: none;
      border-color: var(--cp-primary);
      box-shadow: 0 0 0 1px rgba(122, 60, 255, 0.25);
    }

    .cp-btn-primary {
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #7a3cff, #b43cff);
      color: #fff;
      font-weight: 600;
      padding-block: 9px;
      box-shadow: 0 10px 28px rgba(122, 60, 255, 0.5);
      transition: transform .12s ease-out, box-shadow .12s ease-out;
    }

    .cp-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 34px rgba(122, 60, 255, 0.55);
    }

    .cp-badge-role {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .cp-role-superadmin { background: #1f2937; color: #fef3c7; }
    .cp-role-assigner   { background: #f97316; color: #fff7ed; }
    .cp-role-scheduler  { background: #06b6d4; color: #ecfeff; }
    .cp-role-poster     { background: #22c55e; color: #ecfdf5; }
    .cp-role-viewer     { background: #4f46e5; color: #eef2ff; }

    .cp-app-shell { display: none; min-height: 100vh; }

    .cp-sidebar {
      background: radial-gradient(circle at top, #2f1a4d, #1a0f30);
      color: #e5e0ff;
      min-height: 100vh;
      width: 238px;
      position: fixed;
      inset-block: 0;
      inset-inline-start: 0;
      padding: 18px 14px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .cp-sidebar-logo {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    .cp-sidebar-logo span {
      font-weight: 700;
      letter-spacing: .08em;
      font-size: 11px;
      text-transform: uppercase;
      color: #c4b5fd;
    }

    .cp-nav-pill {
      border-radius: 999px;
      padding: 8px 11px;
      font-size: 13px;
      color: #ede9fe;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background .1s ease-out, transform .1s ease-out, border-color .1s ease-out;
    }

    .cp-nav-pill:hover {
      background: rgba(248, 250, 252, 0.08);
      transform: translateX(2px);
    }

    .cp-nav-pill.active {
      background: rgba(248, 250, 252, 0.16);
      border-color: rgba(248, 250, 252, 0.28);
    }

    .cp-main {
      margin-left: 238px;
      padding: 16px 18px 40px;
    }

    .cp-topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .cp-section-title {
      font-size: 17px;
      font-weight: 700;
    }

    .cp-kpi-card {
      border-radius: 18px;
      padding: 10px 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(239,234,255,0.96));
      border: 1px solid rgba(216,203,255,0.8);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      box-shadow: 0 12px 30px rgba(31, 24, 76, 0.08);
    }

    .cp-kpi-value {
      font-weight: 700;
      font-size: 17px;
    }

    .cp-tag-urgent {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      background: rgba(255, 89, 94, 0.08);
      color: var(--cp-danger);
    }
    .cp-tag-ok {
      border-radius: 999px;
      padding: 3px 10px;
      font-size: 11px;
      background: rgba(138, 201, 38, 0.08);
      color: var(--cp-success);
    }

    .table-sm > :not(caption) > * > * {
      padding-block: 3px;
      padding-inline: 6px;
      font-size: 12px;
    }

    .cp-pill-btn {
      border-radius: 999px;
      border: none;
      padding: 3px 7px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .cp-pill-danger { background: rgba(239, 68, 68, 0.1); color: #b91c1c; }
    .cp-pill-success { background: rgba(22, 163, 74, 0.12); color: #166534; }
    .cp-pill-warning { background: rgba(245, 158, 11, 0.12); color: #92400e; }

    .cp-section-card {
      border-radius: 18px;
      background: rgba(255,255,255,0.96);
      border: 1px solid #e4ddff;
      padding: 12px 12px 10px;
      margin-bottom: 12px;
      box-shadow: 0 10px 24px rgba(31,24,76,0.06);
      animation: fadeUp .3s ease-out;
    }

    .cp-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .cp-section-header h6 {
      margin: 0;
      font-size: 13px;
      font-weight: 600;
    }

    .cp-input-chip {
      font-size: 11px;
      border-radius: 999px;
      background: #f4f1ff;
      padding: 3px 8px;
    }

    .cp-scroll-y {
      max-height: 220px;
      overflow-y: auto;
    }

    .cp-badge-status {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }
    .cp-st-assigned { background: #fee2e2; color: #b91c1c; }
    .cp-st-submitted { background: #fffbeb; color: #92400e; }
    .cp-st-approved { background: #e0f2fe; color: #0369a1; }
    .cp-st-scheduled { background: #e0f7fa; color: #006064; }
    .cp-st-facebook_posted { background: #dbeafe; color: #1d4ed8; }
    .cp-st-instagram_posted { background: #fce7f3; color: #9d174d; }
    .cp-st-completed { background: #dcfce7; color: #166534; }

    .cp-toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      min-width: 230px;
      max-width: 320px;
      z-index: 9999;
      display: none;
    }
    .cp-toast-inner {
      border-radius: 18px;
      background: rgba(255,255,255,0.96);
      border: 1px solid rgba(122,60,255,0.32);
      box-shadow: 0 16px 42px rgba(31,24,76,0.25);
      padding: 10px 12px;
      font-size: 12px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      animation: fadeUp .3s ease-out;
    }

    @media (max-width: 768px) {
      .cp-sidebar {
        transform: translateX(-100%);
        transition: transform .25s ease-out;
        z-index: 1040;
      }
      .cp-sidebar.show {
        transform: translateX(0);
      }
      .cp-main {
        margin-left: 0;
        margin-top: 64px;
      }
    }
    
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="authScreen" class="cp-auth-wrapper">
  <div class="glass-card cp-auth-card">
    <div class="d-flex align-items-center gap-3 mb-3">
      <div class="cp-logo-badge">
        <img src="https://scontent.fccu2-1.fna.fbcdn.net/v/t39.30808-6/581658030_122153183462624100_5274430875005336625_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=30gB-sRgwnsQ7kNvwEimkYz&_nc_oc=AdkvOZhAZiovBUffviOiw5M7KtVx3OgA4043jt2T5wij9gwo6MXohtAIforN5LW1SOUGcRamHxjz7MEtRjKUY30Y&_nc_zt=23&_nc_ht=scontent.fccu2-1.fna&_nc_gid=cuDdqWhcv0pJpezxWdzCNQ&oh=00_AfnYyjBdempzdakkKl355ZPoFhZ3AO_ce-S2WXpqkht2gQ&oe=69484D6A" alt="stars icon" style="width:60px; height:60px;">

        

      </div>
      <div>
        <div class="cp-auth-title">Chinnapatra Panel</div>
        <div class="cp-chip">
          <i class="bi bi-shield-lock"></i>
          Admin & Artist Login
        </div>
      </div>
    </div>

    <!-- ADMIN LOGIN -->
    <form id="loginForm" class="mt-2">
      <div class="mb-2">
        <label class="form-label mb-1 small">Admin Username</label>
        <input type="text" id="loginUsername" class="form-control cp-form-control" required />
      </div>
      <div class="mb-2">
        <label class="form-label mb-1 small">Password</label>
        <input type="password" id="loginPassword" class="form-control cp-form-control" required />
      </div>
      <div class="mb-1 text-muted" style="font-size:11px;">
        Demo: <span class="badge text-bg-dark"></span>
      </div>
      <div class="text-danger small mb-2" id="loginError" style="display:none;"></div>
      <button type="submit" class="btn w-100 cp-btn-primary">
        <i class="bi bi-box-arrow-in-right me-1"></i> Admin Login
      </button>
    </form>

    <hr class="my-3">

    <!-- ARTIST LOGIN -->
    <button type="button" id="btnShowArtistLogin" class="btn btn-sm btn-outline-secondary w-100 mb-2">
      <i class="bi bi-person-badge"></i> Artist Login
    </button>

    <form id="artistLoginForm" class="mt-2" style="display:none;">
      <div class="mb-2">
        <label class="form-label mb-1 small">Artist Username</label>
        <input type="text" id="artistLoginUsername" class="form-control cp-form-control" />
      </div>
      <div class="mb-2">
        <label class="form-label mb-1 small">Password</label>
        <input type="password" id="artistLoginPassword" class="form-control cp-form-control" />
      </div>
      <div class="text-danger small mb-2" id="artistLoginError" style="display:none;"></div>
      <button type="submit" class="btn btn-sm btn-dark w-100">
        <i class="bi bi-box-arrow-in-right me-1"></i> Enter Artist Panel
      </button>
    </form>
  </div>
</div>

<!-- APP SHELL -->
<div id="appShell" class="cp-app-shell">
  <aside id="cp-sidebar" class="cp-sidebar">
    <div class="cp-sidebar-logo">
      <div class="cp-logo-badge" style="width:40px;height:40px;font-size:15px;animation:none;">
        <img src="https://scontent.fccu2-1.fna.fbcdn.net/v/t39.30808-6/581658030_122153183462624100_5274430875005336625_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=6ee11a&_nc_ohc=30gB-sRgwnsQ7kNvwEimkYz&_nc_oc=AdkvOZhAZiovBUffviOiw5M7KtVx3OgA4043jt2T5wij9gwo6MXohtAIforN5LW1SOUGcRamHxjz7MEtRjKUY30Y&_nc_zt=23&_nc_ht=scontent.fccu2-1.fna&_nc_gid=cuDdqWhcv0pJpezxWdzCNQ&oh=00_AfnYyjBdempzdakkKl355ZPoFhZ3AO_ce-S2WXpqkht2gQ&oe=69484D6A" alt="stars icon" style="width:40px; height:40px;">
      </div>
      <div>
        <div style="font-size:13px;font-weight:600;">Chinnapatra</div>
        <span>Post Management</span>
      </div>
    </div>

    <span class="text-uppercase text-muted" style="font-size:10px;letter-spacing:.12em;">Workflow</span>
    <div class="d-flex flex-column gap-1 mt-1" id="cp-nav">
      <div class="cp-nav-pill active" data-section="dashboard">
        <i class="bi bi-speedometer2"></i><span>Dashboard</span>
      </div>
      <div class="cp-nav-pill" data-section="assigner">
        <i class="bi bi-clipboard-check"></i><span>Assign & Approve</span>
      </div>
      <div class="cp-nav-pill" data-section="scheduler">
        <i class="bi bi-calendar2-week"></i><span>Schedule</span>
      </div>
      <div class="cp-nav-pill" data-section="poster">
        <i class="bi bi-send-check"></i><span>Posting</span>
      </div>
      <div class="cp-nav-pill" data-section="viewer">
        <i class="bi bi-graph-up-arrow"></i><span>Analytics</span>
      </div>
      <div class="cp-nav-pill" data-section="admin">
        <i class="bi bi-gear"></i><span>SuperAdmin</span>
      </div>
      <div class="cp-nav-pill" data-section="artist-panel">
        <i class="bi bi-brush"></i><span>Artist Panel</span>
      </div>
    </div>

    <div class="mt-auto pt-2 border-top border-secondary-subtle">
      <div class="d-flex align-items-center justify-content-between mb-1">
        <span style="font-size:11px;">Logged in as</span>
        <span id="userRoleBadge" class="cp-badge-role cp-role-viewer">VIEWER</span>
      </div>
      <div class="d-flex align-items-center justify-content-between">
        <span id="userNameLabel" style="font-size:12px;font-weight:500;">—</span>
        <button id="btnLogout" class="btn btn-sm btn-outline-light rounded-pill px-2 py-0" style="font-size:11px;">
          <i class="bi bi-box-arrow-right"></i>
        </button>
      </div>
    </div>
  </aside>

  <main class="cp-main">
    <header class="cp-topbar">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-secondary d-md-none" id="btn-toggle-sidebar">
          <i class="bi bi-list"></i>
        </button>
        <div>
          <div class="cp-section-title" id="pageTitle">Dashboard</div>
          <div class="text-muted" style="font-size:11px;">FB / IG workflow with task codes</div>
        </div>
      </div>
      <div class="d-flex gap-1">
        <span id="tagUrgent" class="cp-tag-urgent d-none">Urgent tasks</span>
        <span id="tagOk" class="cp-tag-ok d-none">All on time</span>
      </div>
    </header>

    <!-- DASHBOARD -->
    <section id="section-dashboard">
      <div class="row g-2 mb-1">
        <div class="col-6 col-md-3">
          <div class="cp-kpi-card">
            <div>
              <div class="text-muted" style="font-size:11px;">Total Tasks</div>
              <div class="cp-kpi-value" id="kpiTotalTasks">0</div>
            </div>
            <i class="bi bi-clipboard-data text-primary"></i>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="cp-kpi-card">
            <div>
              <div class="text-muted" style="font-size:11px;">Scheduled Posts</div>
              <div class="cp-kpi-value" id="kpiScheduledPosts">0</div>
            </div>
            <i class="bi bi-calendar-check text-info"></i>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="cp-kpi-card">
            <div>
              <div class="text-muted" style="font-size:11px;">FB Pending</div>
              <div class="cp-kpi-value text-danger" id="kpiFacebookPending">0</div>
            </div>
            <i class="bi bi-facebook text-primary"></i>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="cp-kpi-card">
            <div>
              <div class="text-muted" style="font-size:11px;">Completed</div>
              <div class="cp-kpi-value text-success" id="kpiCompleted">0</div>
            </div>
            <i class="bi bi-check-circle text-success"></i>
          </div>
        </div>
      </div>

      <div class="row g-2">
        <div class="col-md-6">
          <div class="cp-section-card">
            <div class="cp-section-header">
              <h6>Urgent Tasks</h6>
              <span class="cp-input-chip"><i class="bi bi-lightning-charge-fill text-warning"></i> Normal / Urgent</span>
            </div>
            <div class="cp-scroll-y">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Artists</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="tblUrgentTasks"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="cp-section-card">
            <div class="cp-section-header">
              <h6>Upcoming Posts</h6>
              <span class="cp-input-chip"><i class="bi bi-stopwatch"></i> Next slots</span>
            </div>
            <div class="cp-scroll-y">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Code</th>
                    <th>Platform</th>
                  </tr>
                </thead>
                <tbody id="tblUpcomingPosts"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ASSIGNER -->
    <section id="section-assigner" class="d-none">
      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>New Task (Assigner)</h6>
          <span class="cp-input-chip"><i class="bi bi-shield-check"></i> Quality Owner</span>
        </div>
        <form id="formNewTask" class="row g-2">
          <div class="col-md-4">
            <label class="form-label small mb-1">Task Type</label>
            <select id="taskTypeSelect" class="form-select form-select-sm">
              <option value="">Select type</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small mb-1">Urgency</label>
            <select id="taskUrgency" class="form-select form-select-sm">
              <option value="normal">Normal</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small mb-1">Submission Source</label>
            <select id="taskSource" class="form-select form-select-sm">
              <option value="system">System</option>
              <option value="whatsapp">WhatsApp</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label small mb-1">Role-wise Instructions</label>
            <textarea id="taskInstructions" class="form-control form-control-sm" rows="2"
              placeholder="Short brief for Poster / Scheduler / others"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label small mb-1">Assign Artists & Roles</label>
            <div class="d-flex gap-1 mb-1">
              <select id="taskArtistSelect" class="form-select form-select-sm">
                <option value="">Artist</option>
              </select>
              <select id="taskArtistRoleSelect" class="form-select form-select-sm" style="max-width:120px;">
                <option value="Poster">Poster</option>
                <option value="Scheduler">Scheduler</option>
                <option value="Viewer">Viewer</option>
              </select>
              <button type="button" id="btnAddArtistToTask" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-plus"></i>
              </button>
            </div>
            <div id="selectedArtistsForTask" class="small text-secondary">No artist added.</div>
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-sm btn-primary rounded-pill">
              <i class="bi bi-clipboard-plus me-1"></i> Create Task
            </button>
          </div>
        </form>
      </div>

      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Pending Approval</h6>
          <span class="cp-input-chip"><i class="bi bi-hourglass-split"></i> Awaiting Approve</span>
        </div>
        <div class="cp-scroll-y">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Task</th>
                <th>Urgency</th>
                <th>Artists</th>
                <th>Source</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="tblPendingApproval"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SCHEDULER -->
    <section id="section-scheduler" class="d-none">
      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Schedule from Approved Tasks</h6>
          <span class="cp-input-chip"><i class="bi bi-calendar-plus"></i> Task Code Mandatory</span>
        </div>
        <form id="formSchedule" class="row g-2">
          <div class="col-md-4">
            <label class="form-label small mb-1">Approved Task</label>
            <select id="scheduleTaskSelect" class="form-select form-select-sm">
              <option value="">Select approved</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">Date</label>
            <input type="date" id="scheduleDate" class="form-control form-control-sm" />
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">Time Slots (comma)</label>
            <input type="text" id="scheduleTimeSlots" class="form-control form-control-sm"
              placeholder="11:00,15:30" />
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-1">Platform</label>
            <select id="schedulePlatform" class="form-select form-select-sm">
              <option value="facebook">FB</option>
              <option value="instagram">IG</option>
              <option value="both">FB + IG</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small mb-1">Post Title</label>
            <input type="text" id="scheduleTitle" class="form-control form-control-sm" />
          </div>
          <div class="col-md-4">
            <label class="form-label small mb-1">Facebook Artist</label>
            <select id="scheduleFacebookArtist" class="form-select form-select-sm">
              <option value="">Optional</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small mb-1">Instagram ID</label>
            <input type="text" id="scheduleInstagramId" class="form-control form-control-sm"
              placeholder="@handle (optional)" />
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="submit" class="btn btn-sm btn-primary rounded-pill">
              <i class="bi bi-calendar2-plus me-1"></i> Add Schedule
            </button>
          </div>
        </form>
      </div>

      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Today & Upcoming Schedules</h6>
          <span class="cp-input-chip"><i class="bi bi-whatsapp"></i> Free WA reminder</span>
        </div>
        <div class="cp-scroll-y">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Code</th>
                <th>Platf.</th>
                <th>WA</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tblSchedules"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- POSTER -->
    <section id="section-poster" class="d-none">
      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Posting Queue</h6>
          <span class="cp-input-chip"><i class="bi bi-broadcast-pin"></i> Mark FB / IG / Both</span>
        </div>
        <div class="cp-scroll-y">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Time</th>
                <th>Task Code</th>
                <th>Title</th>
                <th>Platform</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tblPostingQueue"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- VIEWER -->
    <section id="section-viewer" class="d-none">
      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Performance Snapshot</h6>
          <span class="cp-input-chip"><i class="bi bi-bar-chart-line"></i> Tasks & Posts</span>
        </div>
        <div class="row g-2">
          <div class="col-md-4">
            <div class="cp-kpi-card">
              <div>
                <div class="text-muted" style="font-size:11px;">Artists Assigned</div>
                <div class="cp-kpi-value" id="viewerArtistsAssigned">0</div>
              </div>
              <i class="bi bi-people"></i>
            </div>
          </div>
          <div class="col-md-4">
            <div class="cp-kpi-card">
              <div>
                <div class="text-muted" style="font-size:11px;">On-time vs Delayed</div>
                <div class="cp-kpi-value" id="viewerOnTimeRatio">0/0</div>
              </div>
              <i class="bi bi-alarm"></i>
            </div>
          </div>
          <div class="col-md-4">
            <div class="cp-kpi-card">
              <div>
                <div class="text-muted" style="font-size:11px;">Rework / Rejection</div>
                <div class="cp-kpi-value" id="viewerReworkCount">0</div>
              </div>
              <i class="bi bi-arrow-repeat"></i>
            </div>
          </div>
        </div>
      </div>

      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Report Export</h6>
          <span class="cp-input-chip"><i class="bi bi-filetype-pdf"></i> PDF / JPG</span>
        </div>
        <form id="formReportExport" class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label small mb-1">From</label>
            <input type="date" id="reportFrom" class="form-control form-control-sm" />
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">To</label>
            <input type="date" id="reportTo" class="form-control form-control-sm" />
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-1">Status</label>
            <select id="reportStatus" class="form-select form-select-sm">
              <option value="">All</option>
              <option value="approved">Approved</option>
              <option value="scheduled">Scheduled</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-1">Platform</label>
            <select id="reportPlatform" class="form-select form-select-sm">
              <option value="">All</option>
              <option value="facebook">Facebook</option>
              <option value="instagram">Instagram</option>
              <option value="both">Both</option>
            </select>
          </div>
          <div class="col-md-2 d-flex gap-1">
            <button type="button" id="btnExportPDF" class="btn btn-sm btn-outline-dark w-100">
              <i class="bi bi-file-earmark-pdf"></i>
            </button>
            <button type="button" id="btnExportJPG" class="btn btn-sm btn-outline-secondary w-100">
              <i class="bi bi-file-earmark-image"></i>
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- SUPERADMIN -->
    <section id="section-admin" class="d-none">
      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Users & Artists (SuperAdmin)</h6>
          <span class="cp-input-chip"><i class="bi bi-incognito"></i> Full Control</span>
        </div>
        <div class="row g-2">
          <div class="col-md-6">
            <h6 class="small fw-semibold mb-1">Users</h6>
            <form id="formNewUser" class="row g-1 align-items-end mb-2">
              <div class="col-4">
                <label class="form-label small mb-1">Username</label>
                <input type="text" id="newUserUsername" class="form-control form-control-sm" />
              </div>
              <div class="col-4">
                <label class="form-label small mb-1">Password</label>
                <input type="text" id="newUserPassword" class="form-control form-control-sm" />
              </div>
              <div class="col-3">
                <label class="form-label small mb-1">Role</label>
                <select id="newUserRole" class="form-select form-select-sm">
                  <option>SuperAdmin</option>
                  <option>Assigner</option>
                  <option>Scheduler</option>
                  <option>Poster</option>
                  <option>Viewer</option>
                </select>
              </div>
              <div class="col-1 d-grid">
                <button class="btn btn-sm btn-dark"><i class="bi bi-plus"></i></button>
              </div>
            </form>
            <div class="cp-scroll-y">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Role</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tblUsers"></tbody>
              </table>
            </div>
          </div>

          <div class="col-md-6">
            <h6 class="small fw-semibold mb-1">Artists</h6>
            <form id="formNewArtist" class="row g-1 align-items-end mb-2">
              <div class="col-3">
                <label class="form-label small mb-1">Name</label>
                <input type="text" id="newArtistName" class="form-control form-control-sm" />
              </div>
              <div class="col-3">
                <label class="form-label small mb-1">Category</label>
                <select id="newArtistCategory" class="form-select form-select-sm">
                  <option value="graphics">Graphics</option>
                  <option value="onugolpo">Onugolpo</option>
                  <option value="kobita">Kobita</option>
                  <option value="photography">Photography</option>
                  <option value="calligraphy">Calligraphy</option>
                </select>
              </div>
              <div class="col-3">
                <label class="form-label small mb-1">Phone</label>
                <input type="text" id="newArtistPhone" class="form-control form-control-sm" />
              </div>
              <div class="col-2">
                <label class="form-label small mb-1">Username</label>
                <input type="text" id="newArtistUsername" class="form-control form-control-sm" />
              </div>
              <div class="col-1 d-grid">
                <button class="btn btn-sm btn-dark"><i class="bi bi-plus"></i></button>
              </div>
            </form>
            <div class="cp-scroll-y">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Artist</th>
                    <th>Category</th>
                    <th>Phone</th>
                  </tr>
                </thead>
                <tbody id="tblArtists"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ARTIST PANEL -->
    <section id="section-artist-panel" class="d-none">
      <div class="cp-section-card">
        <div class="cp-section-header">
          <h6>Artist Tasks</h6>
          <span class="cp-input-chip"><i class="bi bi-brush"></i> Graphics / Kobita / Onugolpo etc.</span>
        </div>
        <div class="cp-scroll-y">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Task Code</th>
                <th>Type</th>
                <th>Your Role</th>
                <th>Urgency</th>
                <th>Source</th>
                <th>Submit</th>
              </tr>
            </thead>
            <tbody id="tblArtistTasks"></tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- POPUP TOAST -->
<div id="cp-toast" class="cp-toast">
  <div class="cp-toast-inner">
    <div id="cp-toast-icon"><i class="bi bi-info-circle text-primary"></i></div>
    <div>
      <div id="cp-toast-title" class="fw-semibold mb-1" style="font-size:12px;">Info</div>
      <div id="cp-toast-message" style="font-size:11px;">Message</div>
    </div>
  </div>
</div>

<!-- SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const { createClient } = supabase;
  const SUPABASE_URL = "https://kaqpmotjrnkbcyjcxhkq.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_y-i-qFDPwPhCox3reyxyFQ_DbyZsGt8";
  const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // [web:59][web:88]

  const state = {
    user: null,        // admin user
    artist: null,      // artist user
    selectedTaskArtists: [],
  };

  const $ = (id) => document.getElementById(id);

  function showToast(title, message, iconClass = "bi-info-circle") {
    const wrap = $("cp-toast");
    $("cp-toast-title").innerText = title;
    $("cp-toast-message").innerText = message;
    $("cp-toast-icon").innerHTML = `<i class="bi ${iconClass} text-primary"></i>`;
    wrap.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(() => (wrap.style.display = "none"), 2800);
  }

  function setRoleBadge(role) {
    const el = $("userRoleBadge");
    el.textContent = role?.toUpperCase() || "—";
    el.className = "cp-badge-role";
    if (!role) return;
    if (role === "SuperAdmin") el.classList.add("cp-role-superadmin");
    else if (role === "Assigner") el.classList.add("cp-role-assigner");
    else if (role === "Scheduler") el.classList.add("cp-role-scheduler");
    else if (role === "Poster") el.classList.add("cp-role-poster");
    else el.classList.add("cp-role-viewer");
  }

  function showSection(sec) {
    const sections = ["dashboard", "assigner", "scheduler", "poster", "viewer", "admin", "artist-panel"];
    sections.forEach((s) => {
      const el = document.getElementById("section-" + s);
      if (!el) return;
      el.classList.toggle("d-none", s !== sec);
    });
    document.querySelectorAll(".cp-nav-pill").forEach((p) => {
      p.classList.toggle("active", p.dataset.section === sec);
    });
    const labelMap = {
      dashboard: "Dashboard",
      assigner: "Assign & Approve",
      scheduler: "Schedule",
      poster: "Posting",
      viewer: "Analytics",
      admin: "SuperAdmin",
      "artist-panel": "Artist Panel",
    };
    $("pageTitle").innerText = labelMap[sec] || "Dashboard";
  }

  function applyRoleVisibility(role) {
    const isSuper = role === "SuperAdmin";
    const canAssigner  = isSuper || role === "Assigner";
    const canScheduler = isSuper || role === "Scheduler";
    const canPoster    = isSuper || role === "Poster";
    const canViewer    = isSuper || role === "Viewer";

    const navMap = {
      assigner: canAssigner,
      scheduler: canScheduler,
      poster: canPoster,
      viewer: canViewer,
      admin: isSuper,
      "artist-panel": false,
    };
    Object.entries(navMap).forEach(([sec, can]) => {
      const pill = document.querySelector(`.cp-nav-pill[data-section="${sec}"]`);
      if (pill) pill.style.display = can ? "" : "none";
    });

    if (isSuper) showSection("dashboard");
    else if (role === "Assigner") showSection("assigner");
    else if (role === "Scheduler") showSection("scheduler");
    else if (role === "Poster") showSection("poster");
    else showSection("viewer");
  }

  async function login(username, password) {
    const { data, error } = await db
      .from("users")
      .select("*")
      .eq("username", username)
      .eq("password", password)
      .eq("active", true)
      .single();
    if (error || !data) throw new Error("Invalid credentials");
    return data;
  }

  async function loadDashboard() {
    const [{ data: t }, { data: sp }] = await Promise.all([
      db.from("tasks").select("id,status,urgency,task_code,task_types(name)").order("created_at", { ascending: false }).limit(50),
      db.from("scheduled_posts").select("*").order("scheduled_date", { ascending: true }).limit(50),
    ]);

    const tasks = t || [];
    const posts = sp || [];

    $("kpiTotalTasks").innerText = tasks.length;
    const completed = tasks.filter((x) => x.status === "completed").length;
    $("kpiCompleted").innerText = completed;

    const facebookPending = posts.filter((p) =>
      p.status === "facebook" || p.status === "both"
    ).length;
    $("kpiFacebookPending").innerText = facebookPending;
    $("kpiScheduledPosts").innerText = posts.length;

    const urgentTasks = tasks.filter((x) => x.urgency === "urgent");
    $("tagUrgent").classList.toggle("d-none", urgentTasks.length === 0);
    $("tagOk").classList.toggle("d-none", urgentTasks.length !== 0);

    const urgentBody = $("tblUrgentTasks");
    urgentBody.innerHTML = "";
    urgentTasks.forEach((task) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${task.task_code || "—"}</td>
        <td>${task.task_types?.name || ""}</td>
        <td>-</td>
        <td><span class="cp-badge-status cp-st-${task.status}">${task.status}</span></td>
      `;
      urgentBody.appendChild(tr);
    });

    const upBody = $("tblUpcomingPosts");
    upBody.innerHTML = "";
    posts.forEach((p) => {
      const times = p.time_slots || [];
      const first = times[0] || "";
      const platform = p.status;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.scheduled_date}</td>
        <td>${first}</td>
        <td>${p.task_code}</td>
        <td>${platform}</td>
      `;
      upBody.appendChild(tr);
    });
  }

  async function loadLookups() {
    const [{ data: artists }, { data: taskTypes }, { data: users }] =
      await Promise.all([
        db.from("artists").select("*").order("name"),
        db.from("task_types").select("*").order("name"),
        db.from("users").select("*").order("username"),
      ]);

    const artistSelect = $("taskArtistSelect");
    const schedArtistSelect = $("scheduleFacebookArtist");
    artistSelect.innerHTML = '<option value="">Artist</option>';
    schedArtistSelect.innerHTML = '<option value="">Optional</option>';
    (artists || []).forEach((a) => {
      const opt = document.createElement("option");
      opt.value = a.id;
      opt.textContent = a.name;
      artistSelect.appendChild(opt);

      const opt2 = document.createElement("option");
      opt2.value = a.id;
      opt2.textContent = a.name;
      schedArtistSelect.appendChild(opt2);
    });

    const typeSelect = $("taskTypeSelect");
    typeSelect.innerHTML = '<option value="">Select type</option>';
    (taskTypes || []).forEach((t) => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = t.name;
      typeSelect.appendChild(opt);
    });

    const userBody = $("tblUsers");
    userBody.innerHTML = "";
    (users || []).forEach((u) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.username}</td>
        <td><span class="badge bg-secondary">${u.role}</span></td>
        <td>
          <button class="cp-pill-btn cp-pill-danger btn-sm" data-user-id="${u.id}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      `;
      userBody.appendChild(tr);
    });

    const artistBody = $("tblArtists");
    artistBody.innerHTML = "";
    (artists || []).forEach((a) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${a.name}</td>
        <td>${a.category || ""}</td>
        <td>${a.phone || ""}</td>
      `;
      artistBody.appendChild(tr);
    });
  }

  function renderSelectedArtistsForTask() {
    const container = $("selectedArtistsForTask");
    if (state.selectedTaskArtists.length === 0) {
      container.textContent = "No artist added.";
      return;
    }
    container.innerHTML = state.selectedTaskArtists
      .map((a) => `<span class="badge rounded-pill text-bg-light me-1">${a.name} / ${a.role}</span>`)
      .join("");
  }

  async function loadAssignerTables() {
    const { data: tasks } = await db
      .from("tasks")
      .select("*, task_types(name)")
      .in("status", ["assigned", "submitted"])
      .order("created_at", { ascending: false });

    const body = $("tblPendingApproval");
    body.innerHTML = "";
    (tasks || []).forEach((t) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.task_types?.name || ""}</td>
        <td>${t.urgency}</td>
        <td>-</td>
        <td>${t.submission_source || ""}</td>
        <td>
          <button class="cp-pill-btn cp-pill-success me-1" data-approve-id="${t.id}">
            <i class="bi bi-check2"></i>
          </button>
          <button class="cp-pill-btn cp-pill-warning" data-reject-id="${t.id}">
            <i class="bi bi-arrow-counterclockwise"></i>
          </button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  async function loadSchedulesForSchedulerAndPoster() {
    const { data: posts } = await db
      .from("scheduled_posts")
      .select("*")
      .order("scheduled_date", { ascending: true });

    const schedBody = $("tblSchedules");
    const posterBody = $("tblPostingQueue");
    schedBody.innerHTML = "";
    posterBody.innerHTML = "";

    (posts || []).forEach((p) => {
      const times = p.time_slots || [];
      const first = times[0] || "";
      const waMsg = encodeURIComponent(
        `Reminder: Task ${p.task_code} at ${first} (${p.status.toUpperCase()})`
      );
      const schedTr = document.createElement("tr");
      schedTr.innerHTML = `
        <td>${p.scheduled_date}</td>
        <td>${first}</td>
        <td>${p.task_code}</td>
        <td>${p.status}</td>
        <td>
          <a href="https://wa.me/?text=${waMsg}" target="_blank" class="cp-pill-btn cp-pill-success">
            <i class="bi bi-whatsapp"></i>
          </a>
        </td>
        <td>
          <button class="cp-pill-btn cp-pill-danger" data-del-schedule="${p.id}">
            <i class="bi bi-trash3"></i>
          </button>
        </td>
      `;
      schedBody.appendChild(schedTr);

      const posterTr = document.createElement("tr");
      posterTr.innerHTML = `
        <td>${first}</td>
        <td>${p.task_code}</td>
        <td>${p.post_title || ""}</td>
        <td>${p.status}</td>
        <td>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-primary" data-post-fb="${p.id}">
              <i class="bi bi-facebook"></i>
            </button>
            <button class="btn btn-outline-danger" data-post-ig="${p.id}">
              <i class="bi bi-instagram"></i>
            </button>
            <button class="btn btn-outline-success" data-post-both="${p.id}">
              <i class="bi bi-check2-circle"></i>
            </button>
          </div>
        </td>
      `;
      posterBody.appendChild(posterTr);
    });
  }

  async function loadApprovedTasksForSchedule() {
    const { data } = await db
      .from("tasks")
      .select("id, task_code, task_types(name)")
      .eq("status", "approved")
      .order("created_at", { ascending: false });

    const select = $("scheduleTaskSelect");
    select.innerHTML = '<option value="">Select approved</option>';
    (data || []).forEach((t) => {
      const opt = document.createElement("option");
      opt.value = t.id;
      opt.textContent = `${t.task_code} - ${t.task_types?.name || ""}`;
      select.appendChild(opt);
    });
  }

  async function loadArtistTasks() {
    if (!state.artist) return;
    const artistId = state.artist.id;

    const { data, error } = await db
      .from("task_artists")
      .select("*, tasks(task_code,status,urgency,submission_source,task_types(name))")
      .eq("artist_id", artistId)
      .order("created_at", { ascending: false });

    const body = $("tblArtistTasks");
    body.innerHTML = "";
    (data || []).forEach((row) => {
      const t = row.tasks;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.task_code || "—"}</td>
        <td>${t.task_types?.name || ""}</td>
        <td>${row.assigned_role}</td>
        <td>${t.urgency}</td>
        <td>${t.submission_source || ""}</td>
        <td>
          <button class="cp-pill-btn cp-pill-success" data-artist-submit="${row.id}">
            <i class="bi bi-check2-circle"></i>
          </button>
        </td>
      `;
      body.appendChild(tr);
    });
  }

  async function fullReload() {
    await Promise.all([
      loadDashboard(),
      loadLookups(),
      loadAssignerTables(),
      loadSchedulesForSchedulerAndPoster(),
      loadApprovedTasksForSchedule(),
    ]);
  }

  document.addEventListener("click", async (e) => {
    const pill = e.target.closest(".cp-nav-pill");
    if (pill) {
      showSection(pill.dataset.section);
      if (pill.dataset.section === "dashboard") loadDashboard();
      if (pill.dataset.section === "assigner") loadAssignerTables();
      if (pill.dataset.section === "scheduler") {
        loadSchedulesForSchedulerAndPoster();
        loadApprovedTasksForSchedule();
      }
      if (pill.dataset.section === "poster") loadSchedulesForSchedulerAndPoster();
      if (pill.dataset.section === "artist-panel") loadArtistTasks();
    }

    if (e.target.id === "btn-toggle-sidebar") {
      $("cp-sidebar").classList.toggle("show");
    }

    if (e.target.dataset?.userId) {
      const id = e.target.dataset.userId;
      await db.from("users").delete().eq("id", id);
      showToast("User Removed", "User deleted successfully.", "bi-person-x");
      await loadLookups();
    }

    if (e.target.dataset?.approveId) {
      const id = e.target.dataset.approveId;
      const code = "CP-" + crypto.randomUUID().split("-")[0].toUpperCase();
      await db
        .from("tasks")
        .update({
          status: "approved",
          task_code: code,
          approved_by: state.user?.id || null,
          approved_at: new Date().toISOString(),
        })
        .eq("id", id);
      showToast("Task Approved", `Task code ${code} generated.`, "bi-check2-circle");
      await Promise.all([loadAssignerTables(), loadApprovedTasksForSchedule(), loadDashboard()]);
    }

    if (e.target.dataset?.rejectId) {
      const id = e.target.dataset.rejectId;
      await db
        .from("tasks")
        .update({ status: "assigned" })
        .eq("id", id);
      showToast("Task Rejected", "Sent back to assigned status.", "bi-arrow-counterclockwise");
      await loadAssignerTables();
    }

    if (e.target.dataset?.delSchedule) {
      const id = e.target.dataset.delSchedule;
      await db.from("scheduled_posts").delete().eq("id", id);
      showToast("Schedule Deleted", "Post schedule removed.", "bi-trash3");
      await loadSchedulesForSchedulerAndPoster();
      await loadDashboard();
    }

    if (e.target.dataset?.postFb) {
      const id = e.target.dataset.postFb;
      await db
        .from("scheduled_posts")
        .update({ facebook_posted_at: new Date().toISOString() })
        .eq("id", id);
      showToast("Facebook Posted", "Marked as posted on Facebook.", "bi-facebook");
      await loadSchedulesForSchedulerAndPoster();
      await loadDashboard();
    }
    if (e.target.dataset?.postIg) {
      const id = e.target.dataset.postIg;
      await db
        .from("scheduled_posts")
        .update({ instagram_posted_at: new Date().toISOString() })
        .eq("id", id);
      showToast("Instagram Posted", "Marked as posted on Instagram.", "bi-instagram");
      await loadSchedulesForSchedulerAndPoster();
      await loadDashboard();
    }
    if (e.target.dataset?.postBoth) {
      const id = e.target.dataset.postBoth;
      await db
        .from("scheduled_posts")
        .update({
          facebook_posted_at: new Date().toISOString(),
          instagram_posted_at: new Date().toISOString(),
          status: "completed",
        })
        .eq("id", id);
      showToast("Post Completed", "FB & IG both marked as posted.", "bi-check2-circle");
      await loadSchedulesForSchedulerAndPoster();
      await loadDashboard();
    }

    if (e.target.dataset?.artistSubmit) {
      const id = e.target.dataset.artistSubmit;
      await db
        .from("task_artists")
        .update({ submitted_at: new Date().toISOString() })
        .eq("id", id);
      showToast("Submitted", "Artist submission recorded.", "bi-brush");
      await loadArtistTasks();
    }
  });

  $("btnLogout").addEventListener("click", () => {
    state.user = null;
    state.artist = null;
    $("authScreen").style.display = "flex";
    $("appShell").style.display = "none";
  });

  $("btnShowArtistLogin").addEventListener("click", () => {
    const f = $("artistLoginForm");
    f.style.display = f.style.display === "none" ? "block" : "none";
  });

  $("btnAddArtistToTask").addEventListener("click", () => {
    const artistId = $("taskArtistSelect").value;
    const artistName = $("taskArtistSelect").selectedOptions[0]?.textContent || "";
    const role = $("taskArtistRoleSelect").value;
    if (!artistId || !role) return;
    if (state.selectedTaskArtists.some((a) => a.artist_id === artistId)) return;
    state.selectedTaskArtists.push({ artist_id: artistId, name: artistName, role });
    renderSelectedArtistsForTask();
  });

  $("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("loginError").style.display = "none";
    const u = $("loginUsername").value.trim();
    const p = $("loginPassword").value.trim();
    try {
      const user = await login(u, p);
      state.user = user;
      state.artist = null;
      $("authScreen").style.display = "none";
      $("appShell").style.display = "block";
      $("userNameLabel").innerText = user.username;
      setRoleBadge(user.role);
      applyRoleVisibility(user.role);
      showToast("Welcome", `Logged in as ${user.role}.`, "bi-person-check");
      await fullReload();
    } catch (err) {
      $("loginError").textContent = "Login failed. Wrong username or password.";
      $("loginError").style.display = "block";
    }
  });

  $("artistLoginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    $("artistLoginError").style.display = "none";

    const u = $("artistLoginUsername").value.trim();
    const p = $("artistLoginPassword").value.trim();
    if (!u || !p) return;

    const { data, error } = await db
      .from("artists")
      .select("*")
      .eq("artist_username", u)
      .eq("artist_password", p)
      .single();

    if (error || !data) {
      $("artistLoginError").textContent = "Wrong artist username or password.";
      $("artistLoginError").style.display = "block";
      return;
    }

    state.artist = data;
    state.user = null;
    $("authScreen").style.display = "none";
    $("appShell").style.display = "block";

    $("userNameLabel").innerText = "ARTIST: " + (data.name || data.artist_username);
    const rb = $("userRoleBadge");
    rb.textContent = "ARTIST";
    rb.className = "cp-badge-role cp-role-viewer";

    document.querySelectorAll(".cp-nav-pill").forEach((p) => {
      const sec = p.dataset.section;
      if (sec === "dashboard" || sec === "artist-panel") {
        p.style.display = "";
      } else {
        p.style.display = "none";
      }
    });

    showSection("artist-panel");
    showToast("Welcome", "Artist panel loaded.", "bi-brush");
    await loadArtistTasks();
  });

  $("formNewUser").addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = $("newUserUsername").value.trim();
    const password = $("newUserPassword").value.trim();
    const role = $("newUserRole").value;
    if (!username || !password) return;
    await db.from("users").insert({ username, password, role, active: true });
    $("newUserUsername").value = "";
    $("newUserPassword").value = "";
    showToast("User Added", `User ${username} created.`, "bi-person-plus");
    await loadLookups();
  });

  $("formNewArtist").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = $("newArtistName").value.trim();
    const category = $("newArtistCategory").value;
    const phone = $("newArtistPhone").value.trim();
    const artist_username = $("newArtistUsername").value.trim();
    const artist_password = artist_username || "artist123";
    if (!name) return;
    await db.from("artists").insert({
      name,
      category,
      phone,
      artist_username,
      artist_password,
    });
    $("newArtistName").value = "";
    $("newArtistPhone").value = "";
    $("newArtistUsername").value = "";
    showToast("Artist Added", `Artist ${name} created.`, "bi-brush");
    await loadLookups();
  });

  $("formNewTask").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!state.user) return;
    const task_type_id = $("taskTypeSelect").value;
    const urgency = $("taskUrgency").value;
    const submission_source = $("taskSource").value;
    const instructions = $("taskInstructions").value.trim();
    if (!task_type_id) return;
    const { data, error } = await db
      .from("tasks")
      .insert({
        task_type_id,
        urgency,
        submission_source,
        instructions,
        assigned_by: state.user.id,
        status: "assigned",
      })
      .select("id")
      .single();
    if (error) return;
    const taskId = data.id;
    const rows = state.selectedTaskArtists.map((a) => ({
      task_id: taskId,
      artist_id: a.artist_id,
      assigned_role: a.role,
    }));
    if (rows.length) {
      await db.from("task_artists").insert(rows);
    }
    state.selectedTaskArtists = [];
    renderSelectedArtistsForTask();
    $("taskInstructions").value = "";
    showToast("Task Created", "Task assigned to selected artists.", "bi-clipboard-check");
    await Promise.all([loadAssignerTables(), loadDashboard()]);
  });

  $("formSchedule").addEventListener("submit", async (e) => {
    e.preventDefault();
    const task_id = $("scheduleTaskSelect").value;
    const scheduled_date = $("scheduleDate").value;
    const rawSlots = $("scheduleTimeSlots").value;
    const time_slots = rawSlots
      .split(",")
      .map((t) => t.trim())
      .filter(Boolean);
    const post_title = $("scheduleTitle").value.trim();
    const status = $("schedulePlatform").value;
    const facebook_artist_id = $("scheduleFacebookArtist").value || null;
    const instagram_id = $("scheduleInstagramId").value.trim() || null;
    if (!task_id || !scheduled_date || time_slots.length === 0) return;

    const { data: task } = await db
      .from("tasks")
      .select("task_code")
      .eq("id", task_id)
      .single();
    if (!task?.task_code) return;

    await db.from("scheduled_posts").insert({
      task_id,
      task_code: task.task_code,
      post_title,
      scheduled_date,
      time_slots,
      facebook_artist_id,
      instagram_id,
      status,
    });
    $("scheduleTimeSlots").value = "";
    $("scheduleTitle").value = "";
    showToast("Scheduled", "Post time slots added.", "bi-calendar2-plus");
    await Promise.all([
      loadSchedulesForSchedulerAndPoster(),
      loadDashboard(),
    ]);
  });

  $("formReportExport").addEventListener("submit", (e) => e.preventDefault());
  $("btnExportPDF").addEventListener("click", () => {
    showToast("Report", "Use browser print to export PDF.", "bi-file-earmark-pdf");
    window.print();
  });
  $("btnExportJPG").addEventListener("click", () => {
    showToast("Report", "Capture screenshot for JPG export.", "bi-file-earmark-image");
  });
</script>
</body>
</html>
